<!--pages/statistics/statistics.wxml-->
<view class="statistics-page">
  <!-- é¡µé¢å¤´éƒ¨ -->
  <view class="page-header">
    <view class="header-title">æ•°æ®ç»Ÿè®¡</view>
    <view class="header-subtitle">äº†è§£æ‚¨çš„ä½¿ç”¨æƒ…å†µ</view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-container" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <view class="loading-text">æ­£åœ¨åŠ è½½ç»Ÿè®¡æ•°æ®...</view>
  </view>

  <!-- ä¸»è¦å†…å®¹ -->
  <scroll-view class="main-content" scroll-y wx:else>
    <!-- åŸºç¡€ç»Ÿè®¡å¡ç‰‡ -->
    <view class="stats-overview">
      <view class="stats-card">
        <view class="stats-number">{{basicStats.total}}</view>
        <view class="stats-label">æ€»æé†’</view>
      </view>
      <view class="stats-card warning">
        <view class="stats-number">{{basicStats.warning}}</view>
        <view class="stats-label">å³å°†åˆ°æœŸ</view>
      </view>
      <view class="stats-card danger">
        <view class="stats-number">{{basicStats.expired}}</view>
        <view class="stats-label">å·²è¿‡æœŸ</view>
      </view>
      <view class="stats-card success">
        <view class="stats-number">{{basicStats.completed}}</view>
        <view class="stats-label">å·²å®Œæˆ</view>
      </view>
    </view>

    <!-- æ—¶é—´èŒƒå›´é€‰æ‹© -->
    <view class="time-range-selector">
      <view class="range-tabs">
        <view 
          class="range-tab {{currentPeriod === 'week' ? 'active' : ''}}"
          bindtap="switchPeriod"
          data-period="week"
        >
          æœ¬å‘¨
        </view>
        <view 
          class="range-tab {{currentPeriod === 'month' ? 'active' : ''}}"
          bindtap="switchPeriod"
          data-period="month"
        >
          æœ¬æœˆ
        </view>
        <view 
          class="range-tab {{currentPeriod === 'year' ? 'active' : ''}}"
          bindtap="switchPeriod"
          data-period="year"
        >
          æœ¬å¹´
        </view>
      </view>
    </view>

    <!-- è¶‹åŠ¿å›¾è¡¨ -->
    <view class="chart-section">
      <view class="section-title">
        <text class="title-text">ğŸ“ˆ è¶‹åŠ¿åˆ†æ</text>
      </view>
      <view class="chart-container">
        <canvas 
          class="trend-chart" 
          canvas-id="trendChart"
          disable-scroll="true"
        ></canvas>
        <view class="chart-legend">
          <view class="legend-item" wx:for="{{trendData.datasets}}" wx:key="label">
            <view class="legend-color" style="background-color: {{item.color}}"></view>
            <text class="legend-text">{{item.label}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- åˆ†ç±»ç»Ÿè®¡ -->
    <view class="category-section">
      <view class="section-title">
        <text class="title-text">ğŸ“Š åˆ†ç±»ç»Ÿè®¡</text>
      </view>
      <view class="category-stats">
        <view 
          class="category-item" 
          wx:for="{{categoryStats}}" 
          wx:key="id"
        >
          <view class="category-info">
            <view class="category-icon" style="background-color: {{item.color}}">{{item.icon}}</view>
            <view class="category-details">
              <view class="category-name">{{item.name}}</view>
              <view class="category-count">{{item.total}}ä¸ªæé†’</view>
            </view>
          </view>
          <view class="category-progress">
            <view class="progress-bar">
              <view 
                class="progress-fill" 
                style="width: {{item.percentage}}%; background-color: {{item.color}}"
              ></view>
            </view>
            <view class="progress-text">{{item.percentage}}%</view>
          </view>
          <view class="category-status">
            <view class="status-item">
              <text class="status-label">æ­£å¸¸</text>
              <text class="status-value">{{item.normal}}</text>
            </view>
            <view class="status-item warning">
              <text class="status-label">è­¦å‘Š</text>
              <text class="status-value">{{item.warning}}</text>
            </view>
            <view class="status-item danger">
              <text class="status-label">è¿‡æœŸ</text>
              <text class="status-value">{{item.expired}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- ä½¿ç”¨ä¹ æƒ¯åˆ†æ -->
    <view class="usage-section">
      <view class="section-title">
        <text class="title-text">ğŸ• ä½¿ç”¨ä¹ æƒ¯</text>
      </view>
      
      <!-- æ—¶é—´åå¥½ -->
      <view class="usage-card">
        <view class="card-title">æ´»è·ƒæ—¶é—´æ®µ</view>
        <view class="time-preferences">
          <view class="time-slot">
            <view class="time-label">ä¸Šåˆ</view>
            <view class="time-bar">
              <view 
                class="time-fill" 
                style="width: {{usageAnalysis.timePreferences.morning / basicStats.total * 100}}%"
              ></view>
            </view>
            <view class="time-count">{{usageAnalysis.timePreferences.morning}}</view>
          </view>
          <view class="time-slot">
            <view class="time-label">ä¸‹åˆ</view>
            <view class="time-bar">
              <view 
                class="time-fill" 
                style="width: {{usageAnalysis.timePreferences.afternoon / basicStats.total * 100}}%"
              ></view>
            </view>
            <view class="time-count">{{usageAnalysis.timePreferences.afternoon}}</view>
          </view>
          <view class="time-slot">
            <view class="time-label">æ™šä¸Š</view>
            <view class="time-bar">
              <view 
                class="time-fill" 
                style="width: {{usageAnalysis.timePreferences.evening / basicStats.total * 100}}%"
              ></view>
            </view>
            <view class="time-count">{{usageAnalysis.timePreferences.evening}}</view>
          </view>
          <view class="time-slot">
            <view class="time-label">æ·±å¤œ</view>
            <view class="time-bar">
              <view 
                class="time-fill" 
                style="width: {{usageAnalysis.timePreferences.night / basicStats.total * 100}}%"
              ></view>
            </view>
            <view class="time-count">{{usageAnalysis.timePreferences.night}}</view>
          </view>
        </view>
      </view>

      <!-- å®Œæˆç‡ -->
      <view class="usage-card">
        <view class="card-title">å®Œæˆç‡ç»Ÿè®¡</view>
        <view class="completion-stats">
          <view class="completion-item">
            <view class="completion-label">æ€»ä½“å®Œæˆç‡</view>
            <view class="completion-value">{{usageAnalysis.completionRate.overall}}%</view>
            <view class="completion-bar">
              <view 
                class="completion-fill" 
                style="width: {{usageAnalysis.completionRate.overall}}%"
              ></view>
            </view>
          </view>
          <view class="completion-item">
            <view class="completion-label">æœ¬å‘¨å®Œæˆç‡</view>
            <view class="completion-value">{{usageAnalysis.completionRate.thisWeek}}%</view>
            <view class="completion-bar">
              <view 
                class="completion-fill" 
                style="width: {{usageAnalysis.completionRate.thisWeek}}%"
              ></view>
            </view>
          </view>
          <view class="completion-item">
            <view class="completion-label">æœ¬æœˆå®Œæˆç‡</view>
            <view class="completion-value">{{usageAnalysis.completionRate.thisMonth}}%</view>
            <view class="completion-bar">
              <view 
                class="completion-fill" 
                style="width: {{usageAnalysis.completionRate.thisMonth}}%"
              ></view>
            </view>
          </view>
        </view>
      </view>

      <!-- æ´»è·ƒåº¦ -->
      <view class="usage-card">
        <view class="card-title">æ´»è·ƒåº¦åˆ†æ</view>
        <view class="activity-stats">
          <view class="activity-item">
            <view class="activity-number">{{usageAnalysis.activity.dailyAvg}}</view>
            <view class="activity-label">æ—¥å‡æ·»åŠ </view>
          </view>
          <view class="activity-item">
            <view class="activity-number">{{usageAnalysis.activity.weeklyAvg}}</view>
            <view class="activity-label">å‘¨å‡æ·»åŠ </view>
          </view>
          <view class="activity-item">
            <view class="activity-number">{{usageAnalysis.activity.peakHour}}:00</view>
            <view class="activity-label">æ´»è·ƒæ—¶æ®µ</view>
          </view>
        </view>
      </view>
    </view>

    <!-- æ•ˆç‡æŠ¥å‘Š -->
    <view class="efficiency-section">
      <view class="section-title">
        <text class="title-text">ğŸ¯ æ•ˆç‡æŠ¥å‘Š</text>
      </view>
      
      <view class="efficiency-card">
        <view class="efficiency-header">
          <view class="efficiency-score">
            <view class="score-number">{{efficiencyReport.score}}</view>
            <view class="score-label">æ•ˆç‡è¯„åˆ†</view>
          </view>
          <view class="efficiency-level">
            <view class="level-badge level-{{efficiencyReport.level}}">
              {{efficiencyReport.level === 'expert' ? 'ä¸“å®¶' : 
                efficiencyReport.level === 'advanced' ? 'é«˜çº§' :
                efficiencyReport.level === 'intermediate' ? 'ä¸­çº§' : 'åˆçº§'}}
            </view>
          </view>
        </view>
        
        <view class="efficiency-metrics">
          <view class="metric-item">
            <view class="metric-label">æŒ‰æ—¶å®Œæˆç‡</view>
            <view class="metric-value">{{efficiencyReport.metrics.onTimeCompletion}}%</view>
          </view>
          <view class="metric-item">
            <view class="metric-label">å¹³å‡å“åº”æ—¶é—´</view>
            <view class="metric-value">{{efficiencyReport.metrics.avgResponseTime}}å°æ—¶</view>
          </view>
          <view class="metric-item">
            <view class="metric-label">ä¸»åŠ¨æ€§è¯„åˆ†</view>
            <view class="metric-value">{{efficiencyReport.metrics.proactiveRate}}%</view>
          </view>
          <view class="metric-item">
            <view class="metric-label">ä¸€è‡´æ€§è¯„åˆ†</view>
            <view class="metric-value">{{efficiencyReport.metrics.consistencyScore}}%</view>
          </view>
        </view>
        
        <!-- æ´å¯Ÿ -->
        <view class="insights-section" wx:if="{{efficiencyReport.insights.length > 0}}">
          <view class="insights-title">ğŸ’¡ æ•°æ®æ´å¯Ÿ</view>
          <view class="insights-list">
            <view 
              class="insight-item" 
              wx:for="{{efficiencyReport.insights}}" 
              wx:key="*this"
            >
              {{item}}
            </view>
          </view>
        </view>
        
        <!-- å»ºè®® -->
        <view class="recommendations-section" wx:if="{{efficiencyReport.recommendations.length > 0}}">
          <view class="recommendations-title">ğŸš€ æ”¹è¿›å»ºè®®</view>
          <view class="recommendations-list">
            <view 
              class="recommendation-item" 
              wx:for="{{efficiencyReport.recommendations}}" 
              wx:key="*this"
            >
              {{item}}
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="action-section">
      <button class="action-btn" bindtap="exportData">
        <text class="btn-icon">ğŸ“¤</text>
        <text class="btn-text">å¯¼å‡ºæ•°æ®</text>
      </button>
      <button class="action-btn secondary" bindtap="refreshData">
        <text class="btn-icon">ğŸ”„</text>
        <text class="btn-text">åˆ·æ–°æ•°æ®</text>
      </button>
    </view>
  </scroll-view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:if="{{!loading && basicStats.total === 0}}">
    <view class="empty-icon">ğŸ“Š</view>
    <view class="empty-title">æš‚æ— ç»Ÿè®¡æ•°æ®</view>
    <view class="empty-description">æ·»åŠ ä¸€äº›æé†’åå°±èƒ½çœ‹åˆ°è¯¦ç»†çš„ç»Ÿè®¡åˆ†æäº†</view>
    <button class="empty-action" bindtap="goToAdd">
      ç«‹å³æ·»åŠ æé†’
    </button>
  </view>
</view>